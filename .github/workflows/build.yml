name: Build Android Kernel for Enchilada or Fajita

on:
  workflow_dispatch:
    inputs:
      pseudo_make:
        description: "Pseudo Make"
        type: boolean
        default: false

  schedule:
    - cron: "50 9,21 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Cloning Kernel Sources and Parparing Environment
        run: |
          echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%Y%m%d%H%M")" >> $GITHUB_ENV
          sudo apt update -y
          sudo apt-get install git ccache wget automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python2 python3
          sudo apt clean
          git clone https://github.com/Grill-Laux/kernel_oneplus_sdm845 android-kernel --recursive --depth=1 -b oos/wip-upstream
          mkdir -p ~/toolchains/clang && cd ~/toolchains/clang && wget -O clang.tar.gz https://android.googlesource.com/platform//prebuilts/clang/host/linux-x86/+archive/refs/tags/android-14.0.0_r0.78/clang-r416183b.tar.gz && tar zxvf clang.tar.gz && rm -f clang.tar.gz && cd -
          #git clone https://github.com/Grill-Laux/android_prebuilts_misc_linux-x86_dtc_dtc ~/toolchains/dtc
          
      - name: Cloning GCC
        run: |
          git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b android-10.0.0_r47 --depth=1 --single-branch --no-tags ~/toolchains/aarch64-linux-android-4.9
          git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 -b android-10.0.0_r47 --depth=1 --single-branch --no-tags ~/toolchains/arm-linux-androideabi-4.9

       

      - name: Compiling Kernel
        run: |
          CLANG=~/toolchains/clang/bin
          GCC32=~/toolchains/arm-linux-androideabi-4.9/bin
          GCC64=~/toolchains/aarch64-linux-android-4.9/bin
          PATH=$CLANG:$GCC64:$GCC32:$PATH
          export PATH
          export ARCH=arm64
          export CLANG_TRIPLE=aarch64-linux-gnu
          export CROSS_COMPILE=aarch64-linux-android-
          export CROSS_COMPILE_ARM32=arm-linux-androideabi-
          output_dir=out
          pushd android-kernel
          make O="$output_dir" sdm845-perf_defconfig
          make -j $(nproc) O="$output_dir" CC=clang
          popd
          
      - name: Make AnyKernel3 zip
        run: |
          mkdir -p out/arch/arm64/boot/
          curl -Lo AnyKernel3.zip https://github.com/Grill-Laux/AnyKernel3/archive/refs/heads/master.zip
          unzip AnyKernel3.zip
          cd AnyKernel3-master
          cat > anykernel.sh <<EOF
          properties() { '
          do.devicecheck=0
          do.cleanup=1
          device.name1=enchilada
          '; }
          block=auto
          is_slot_device=auto
          . tools/ak3-core.sh
          split_boot
          flash_boot
          EOF
          cp $GITHUB_WORKSPACE/android-kernel/out/arch/arm64/boot/Image.gz-dtb .
          zip -r boot.zip * -x .git README.md *placeholder
          ls
#这里改下哦 把所有需要修改的路径和image格式都改下

#      - name: Upload AnyKernel3
#        uses: actions/upload-artifact@v3
#        with:
#          name: AnyKernel3_enchilada-lineageos-${{ env.BUILD_TIME }}
#          path: anykernel/*
#          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: OxygenOS_test_${{ env.BUILD_TIME }}_manual
          body: |
            Device:
            enchilada / fajita

            Kernel Source:
            github.com/Grill-Laux/kernel_oneplus_sdm845
            
            TEST VERSION.
            This version only for test, it isn't supported ksu.
            WARNING:
            I do NOT make any express or implied guarantee that you will not be able to boot after flashing this kernel.
            If you do not know how to flash the boot image from offical payload.bin , DO NOT try to flash!!!
        
          files: |
            AnyKernel3-master/boot.zip
            android-kernel/out/arch/arm64/boot/*
